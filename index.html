-- Simple encodage Base64
function base64encode(data)
    local b64chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'
    local t = {}
    local pad = ''
    local remainder = #data % 3

    if remainder > 0 then
        for i = 1, 3 - remainder do
            pad = pad .. '='
            data = data .. '\0'
        end
    end

    for i = 1, #data, 3 do
        local n = (data:byte(i) << 16) + (data:byte(i + 1) << 8) + data:byte(i + 2)
        t[#t+1] = b64chars:sub((n >> 18 & 0x3F) + 1, (n >> 18 & 0x3F) + 1)
        t[#t+1] = b64chars:sub((n >> 12 & 0x3F) + 1, (n >> 12 & 0x3F) + 1)
        t[#t+1] = b64chars:sub((n >> 6 & 0x3F) + 1, (n >> 6 & 0x3F) + 1)
        t[#t+1] = b64chars:sub((n & 0x3F) + 1, (n & 0x3F) + 1)
    end

    local result = table.concat(t)
    if #pad > 0 then
        result = result:sub(1, -(#pad + 1)) .. pad
    end
    return result
end

function optimizeHTML(html)
    -- Supprimer les commentaires
    html = html:gsub("<!--.--->", "")
    -- Supprimer les espaces multiples
    html = html:gsub("%s+", " ")
    -- Supprimer les espaces autour des balises
    html = html:gsub(">%s+<", "><")
    return html
end

-- Variables globales pour g√©rer l'√©tat du menu
local dui = nil
local menuVisible = false
local selectedIndex = 1
local menuItems = {
    "Player", "Server", "Weapon", "Combat", 
    "Vehicle", "Visual", "Miscellaneous", "Settings", "Search"
}

-- HTML UI professionnel avec design moderne
local html = [[
<!DOCTYPE html>
<html>
<head>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', sans-serif;
    background: transparent;
    overflow: hidden;
}

.menu-container {
    width: 420px;
    background: linear-gradient(145deg, rgba(0, 0, 0, 0.95), rgba(20, 20, 25, 0.95));
    border-radius: 16px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    overflow: hidden;
}

.header {
    height: 90px;
    background: linear-gradient(135deg, #dc2626, #b91c1c, #991b1b);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
}

.header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
    animation: shine 3s infinite;
}

@keyframes shine {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.header h1 {
    font-size: 32px;
    font-weight: 700;
    color: white;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    letter-spacing: 2px;
    z-index: 1;
}

.menu-section {
    background: rgba(10, 10, 15, 0.8);
    padding: 0;
}

.section-title {
    background: linear-gradient(90deg, rgba(220, 38, 38, 0.2), rgba(220, 38, 38, 0.05));
    border-left: 4px solid #dc2626;
    padding: 12px 20px;
    font-size: 11px;
    color: #dc2626;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.menu-items {
    padding: 8px 0;
}

.menu-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    color: #e2e8f0;
    font-size: 15px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.menu-item::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 0;
    background: linear-gradient(90deg, #dc2626, rgba(220, 38, 38, 0.3));
    transition: width 0.3s ease;
}

.menu-item:hover {
    background: rgba(220, 38, 38, 0.1);
    color: white;
    transform: translateX(8px);
}

.menu-item:hover::before {
    width: 4px;
}

.menu-item.selected {
    background: linear-gradient(90deg, rgba(220, 38, 38, 0.2), rgba(220, 38, 38, 0.05));
    color: white;
    font-weight: 600;
    transform: translateX(8px);
}

.menu-item.selected::before {
    width: 4px;
}

.menu-item .icon {
    width: 20px;
    height: 20px;
    margin-right: 12px;
    opacity: 0.7;
}

.menu-item .arrow {
    color: #64748b;
    font-size: 18px;
    transition: all 0.2s ease;
}

.menu-item:hover .arrow,
.menu-item.selected .arrow {
    color: #dc2626;
    transform: translateX(4px);
}

.menu-footer {
    background: rgba(5, 5, 10, 0.9);
    padding: 16px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.footer-left {
    display: flex;
    align-items: center;
    gap: 10px;
}

.user-avatar {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: linear-gradient(135deg, #dc2626, #b91c1c);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
    font-weight: 600;
}

.user-info .user-id {
    color: #ffffff;
    font-weight: 600;
    font-size: 13px;
}

.user-info .user-status {
    color: #64748b;
    font-size: 11px;
}

.footer-page {
    color: #94a3b8;
    font-size: 12px;
    font-weight: 500;
    background: rgba(255, 255, 255, 0.05);
    padding: 4px 8px;
    border-radius: 6px;
}

.search-item {
    position: relative;
}

.search-item .search-icon {
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    color: #64748b;
    font-size: 16px;
}

/* Animation d'entr√©e */
.menu-container {
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* Responsive */
@media (max-width: 480px) {
    .menu-container {
        width: 350px;
    }
}
</style>
</head>
<body>
<div class="menu-container">
    <div class="header">
        <h1>Phaze</h1>
    </div>
    
    <div class="menu-section">
        <div class="section-title">Main menu</div>
        <div class="menu-items">
            <div class="menu-item selected">
                <span>Player</span>
                <span class="arrow">‚Ä∫</span>
            </div>
            <div class="menu-item">
                <span>Server</span>
                <span class="arrow">‚Ä∫</span>
            </div>
            <div class="menu-item">
                <span>Weapon</span>
                <span class="arrow">‚Ä∫</span>
            </div>
            <div class="menu-item">
                <span>Combat</span>
                <span class="arrow">‚Ä∫</span>
            </div>
            <div class="menu-item">
                <span>Vehicle</span>
                <span class="arrow">‚Ä∫</span>
            </div>
            <div class="menu-item">
                <span>Visual</span>
                <span class="arrow">‚Ä∫</span>
            </div>
            <div class="menu-item">
                <span>Miscellaneous</span>
                <span class="arrow">‚Ä∫</span>
            </div>
            <div class="menu-item">
                <span>Settings</span>
                <span class="arrow">‚Ä∫</span>
            </div>
            <div class="menu-item search-item">
                <span>Search</span>
                <span class="search-icon">üîç</span>
            </div>
        </div>
    </div>
    
    <div class="menu-footer">
        <div class="footer-left">
            <div class="user-avatar">P</div>
            <div class="user-info">
                <div class="user-id">240097</div>
                <div class="user-status">1mo ago</div>
            </div>
        </div>
        <div class="footer-page">4/9</div>
    </div>
</div>

<script>
let selectedIndex = 0;
const menuItems = document.querySelectorAll('.menu-item');

// Fonction pour mettre √† jour la s√©lection
function updateSelection(newIndex) {
    // Retirer la classe selected de l'√©l√©ment actuel
    menuItems[selectedIndex].classList.remove('selected');
    
    // Mettre √† jour l'index
    selectedIndex = newIndex;
    
    // Ajouter la classe selected au nouvel √©l√©ment
    menuItems[selectedIndex].classList.add('selected');
}

// Navigation au clavier
document.addEventListener('keydown', function(event) {
    switch(event.key) {
        case 'ArrowUp':
            event.preventDefault();
            const newUpIndex = selectedIndex > 0 ? selectedIndex - 1 : menuItems.length - 1;
            updateSelection(newUpIndex);
            break;
            
        case 'ArrowDown':
            event.preventDefault();
            const newDownIndex = selectedIndex < menuItems.length - 1 ? selectedIndex + 1 : 0;
            updateSelection(newDownIndex);
            break;
            
        case 'Enter':
            event.preventDefault();
            // Simuler un clic sur l'√©l√©ment s√©lectionn√©
            menuItems[selectedIndex].click();
            break;
            
        case 'Escape':
        case 'g':
        case 'G':
            // Fermer le menu
            if (window.parent) {
                window.parent.postMessage({ type: 'keyPressed', key: 'G' }, '*');
            }
            break;
    }
});

// Gestion des clics souris
menuItems.forEach((item, index) => {
    item.addEventListener('click', function() {
        updateSelection(index);
        // Ici vous pouvez ajouter la logique pour chaque menu
        console.log('Menu s√©lectionn√©:', item.textContent.trim());
    });
    
    // Effet hover avec la souris
    item.addEventListener('mouseenter', function() {
        if (index !== selectedIndex) {
            updateSelection(index);
        }
    });
});

// √âcouter les messages du script Lua
window.addEventListener('message', function(event) {
    if (event.data && event.data.type === 'toggleMenu') {
        const container = document.querySelector('.menu-container');
        if (event.data.visible) {
            container.style.display = 'block';
            // Focus sur le menu pour les √©v√©nements clavier
            document.body.focus();
        } else {
            container.style.display = 'none';
        }
    }
    
    // Gestion de la navigation depuis Lua
    if (event.data && event.data.type === 'navigate') {
        if (event.data.direction === 'up') {
            const newIndex = selectedIndex > 0 ? selectedIndex - 1 : menuItems.length - 1;
            updateSelection(newIndex);
        } else if (event.data.direction === 'down') {
            const newIndex = selectedIndex < menuItems.length - 1 ? selectedIndex + 1 : 0;
            updateSelection(newIndex);
        }
    }
});

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    // Assurer que le premier √©l√©ment est s√©lectionn√©
    updateSelection(0);
});
</script>
</body>
</html>
]]

html = optimizeHTML(html)

local encoded = base64encode(html)
local data_uri = "data:text/html;base64," .. encoded
dui = MachoCreateDui(data_uri)

-- Fonction pour basculer la visibilit√© du menu
function toggleMenu()
    menuVisible = not menuVisible
    if menuVisible then
        MachoShowDui(dui)
        MachoSendDuiMessage(dui, '{"type":"toggleMenu","visible":true}')
    else
        MachoHideDui(dui)
        MachoSendDuiMessage(dui, '{"type":"toggleMenu","visible":false}')
    end
end

-- Fonction pour naviguer dans le menu
function navigateMenu(direction)
    if menuVisible then
        MachoSendDuiMessage(dui, '{"type":"navigate","direction":"' .. direction .. '"}')
    end
end

-- Fonction pour g√©rer les touches press√©es
function handleKeyPress(key)
    if key == "G" then
        toggleMenu()
    elseif menuVisible then
        if key == "UP" then
            navigateMenu("up")
        elseif key == "DOWN" then
            navigateMenu("down")
        elseif key == "ENTER" then
            -- Logique pour s√©lectionner l'√©l√©ment actuel
            print("Item s√©lectionn√©: " .. menuItems[selectedIndex])
        end
    end
end

-- Thread principal pour la gestion des touches
Citizen.CreateThread(function()
    while true do
        Citizen.Wait(0)
        
        -- Touche G pour ouvrir/fermer le menu
        if IsControlJustPressed(0, 47) then -- G
            handleKeyPress("G")
        end
        
        -- Navigation uniquement si le menu est visible
        if menuVisible then
            -- Fl√®che du haut
            if IsControlJustPressed(0, 172) then -- UP
                selectedIndex = selectedIndex > 1 and selectedIndex - 1 or #menuItems
                navigateMenu("up")
            end
            
            -- Fl√®che du bas
            if IsControlJustPressed(0, 173) then -- DOWN
                selectedIndex = selectedIndex < #menuItems and selectedIndex + 1 or 1
                navigateMenu("down")
            end
            
            -- Entr√©e pour s√©lectionner
            if IsControlJustPressed(0, 18) then -- ENTER
                handleKeyPress("ENTER")
            end
            
            -- √âchap pour fermer
            if IsControlJustPressed(0, 322) then -- ESC
                handleKeyPress("G")
            end
        end
    end
end)

-- Initialiser le menu comme cach√©
menuVisible = false
selectedIndex = 1
MachoHideDui(dui)
